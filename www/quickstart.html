<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<h3>Quickstart</h3>
<p>This is a step-by-step guide to create a simple chat application. It consists of a sender to post messages you type to a JMS Topic and a receiver to display all messages coming in from that topic. Both are implemented as simple servlets. Most of the things in it could have to be done with plain JMS as well. But if you know JMS, you'll see the big difference in the code you <i>don't</i> have to write. If you prefer to download everything, you can get it <a href="https://messageapi.dev.java.net/source/browse/messageapi/trunk/demo/">here</a>. To make the interesting things more visible, the stuff that's not specific to the MessageApi but just to make the servlets work, is set in <span style="color:grey">grey</span>. You can skip that, if you just want to get an impression of how to work with the MessageApi.</p>

<p><small style="color:green">Things we are working on to make it even easier, are set in green and small.</small></p>

<p>This demo is done with maven 2.2.1 and Glassfish 3.0.1. But it should be easy to adapt to any container supporting JMS and to any build tool.</p>

<h3>Build the MessageApi</h3>
<ol>
<li><tt>svn co https://messageapi.dev.java.net/svn/messageapi/trunk messageapi</tt></li>
<li><tt>cd messageapi</tt></li>
<li><tt>mvn clean install</tt>
<br/><small style="color:green">we are working on getting the messageapi into a maven repository, so you could skip this step.</small></li>
</ol>

<h3>Create the Chat-API</h3>
<ol>
<li><tt>mvn archetype:create -DgroupId=chat -DartifactId=chat-api -DarchetypeGroupId=net.java.messageapi -DarchetypeArtifactId=api-archetype -DarchetypeVersion=1.1 -DremoteRepositories=http://download.java.net/maven/2</tt></li>
<li>replace the sample <tt>MyMessageApi.java</tt> with your own <tt>ChatApi.java</tt>:
<pre>@MessageApi
public interface ChatApi {
	public void send(String message);
}</pre>
</li>
<li><tt>mvn clean install</tt></li>
</ol>

<h3>Create the Sender</h3>
<ol>
<li style="color:grey">create a web project: <tt>mvn archetype:generate -B -DarchetypeGroupId=org.codehaus.mojo.archetypes -DarchetypeArtifactId=webapp-javaee6 -DgroupId=net.java.dev.messageapi -DartifactId=chat-send -Dpackage=net.java.dev.messageapi.chat</tt></li>
<li>add dependencies to your <tt>chat-api</tt> and the <tt>messageapi:adapter</tt></li>
<li style="color:grey">remove the file <tt>src/main/webapp/index.jsp</tt></li>
<li style="color:grey">create the folder <tt>src/main/webapp/WEB-INF</tt></li>
<li style="color:grey">create the file <tt>web.xml</tt> in that folder with this contents:<pre>
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;web-app version="2.5" xmlns="http://java.sun.com/xml/ns/javaee"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd"&gt;
	&lt;servlet&gt;
		&lt;servlet-name&gt;ChatSend&lt;/servlet-name&gt;
		&lt;servlet-class&gt;net.java.dev.messageapi.chat.ChatSend&lt;/servlet-class&gt;
	&lt;/servlet&gt;
	&lt;servlet-mapping&gt;
		&lt;servlet-name&gt;ChatSend&lt;/servlet-name&gt;
		&lt;url-pattern&gt;/chat-send&lt;/url-pattern&gt;
	&lt;/servlet-mapping&gt;
	&lt;welcome-file-list&gt;
		&lt;welcome-file&gt;chat-send&lt;/welcome-file&gt;
	&lt;/welcome-file-list&gt;
&lt;/web-app&gt;
</pre></li>
<li>create the <tt>net.java.dev.messageapi.chat.ChatSend.java</tt> (the imports and stuff are left out for brevity):
<pre>
<span style="color:grey">public class ChatSend extends HttpServlet {
    private static final long serialVersionUID = 1L;
</span>
    private final ChatApi chat = MessageSender.of(ChatApi.class);

<span style="color:grey">    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response)
            throws IOException {
        // we're not expecting any GET parameters!
        response(response);
    }

    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response)
            throws IOException {
        request(request);
        response(response);
    }

    private void request(HttpServletRequest request) {
        String message = request.getParameter("message");
        if (message != null && message.length() &gt; 0) {</span>
            chat.send(message);
<span style="color:grey">        }
    }

    private void response(HttpServletResponse response) throws IOException {
        PrintWriter out = response.getWriter();
        out.println("&lt;html&gt;");
        out.println("  &lt;head&gt;&lt;title&gt;Chat Send&lt;/title&gt;&lt;/head&gt;");
        out.println("  &lt;body&gt;");
        out.println("    &lt;h2&gt;Please enter your message&lt;/h2&gt;");
        out.println("    &lt;form method=\"post\" action=\"chat-send\"&gt;&lt;p/&gt;");
        out.println("      &lt;input type=\"text\" name=\"message\" size=\"50\"/&gt;&lt;br/&gt;");
        out.println("      &lt;input type=\"submit\" value=\"Send\" /&gt;");
        out.println("    &lt;/form&gt;");
        out.println("  &lt;/body&gt;");
        out.println("&lt;/html&gt;");
    }
}</span>
</pre></li>
<li>Create the configuration file <tt>chat.ChatApi.config</tt>:
<pre>
&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;
&lt;jmsSenderFactory api="net.java.messageapi.test.TestApi"&gt;
    &lt;destination name="ChatTopic"&gt;
        &lt;factory&gt;ConnectionFactory&lt;/factory&gt;
        &lt;user&gt;guest&lt;/user&gt;
        &lt;pass&gt;guest&lt;/pass&gt;
        &lt;transacted&gt;true&lt;/transacted&gt;
    &lt;/destination&gt;
    &lt;xmlJmsPayloadHandler/&gt;
&lt;/jmsSenderFactory&gt;
</pre>
<small style="color:green">we are working on a automatic registry for services, so this config would be unnecessary.</small></li>
<li style="color:grey">build the war: <tt>mvn clean verify</tt></li>
</ol>

<h3>Create the Receiver</h3>
<ol>
<li style="color:grey">create another web project: <tt>mvn archetype:generate -B -DarchetypeGroupId=org.codehaus.mojo.archetypes -DarchetypeArtifactId=webapp-javaee6 -DgroupId=net.java.dev.messageapi -DartifactId=chat-<b>receive</b> -Dpackage=net.java.dev.messageapi.chat</tt></li>
<li style="color:grey">change the <tt>javaee-web-api</tt> to the full <tt>javaee-api</tt>; we'll add a MDB</li>
<li style="color:grey">add dependencies to the <tt>chat-api</tt> and the <tt>message-api:adapter</tt></li>
<li style="color:grey">remove the file <tt>src/main/webapp/index.jsp</tt></li>
<li style="color:grey">create the folder <tt>src/main/webapp/WEB-INF</tt></li>
<li style="color:grey">create the file <tt>web.xml</tt> in that folder with this contents:<pre>
&lt;web-app version="2.5" xmlns="http://java.sun.com/xml/ns/javaee"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd"&gt;
	&lt;servlet&gt;
		&lt;servlet-name&gt;ChatReceive&lt;/servlet-name&gt;
		&lt;servlet-class&gt;net.java.dev.messageapi.chat.ChatReceiveServlet&lt;/servlet-class&gt;
	&lt;/servlet&gt;
	&lt;servlet-mapping&gt;
		&lt;servlet-name&gt;ChatReceive&lt;/servlet-name&gt;
		&lt;url-pattern&gt;/chat-receive&lt;/url-pattern&gt;
	&lt;/servlet-mapping&gt;
	&lt;welcome-file-list&gt;
		&lt;welcome-file&gt;chat-receive&lt;/welcome-file&gt;
	&lt;/welcome-file-list&gt;
&lt;/web-app&gt;
</pre></li>
<li>create the <tt>net.java.dev.messageapi.chat.ChatReceiver</tt>:
<pre>
public class ChatReceiver implements ChatApi {
<span style="color:grey">
    static List&lt;String&gt; messages = new ArrayList&lt;String&gt;();
</span>
    @Override
    public void send(String message) {<span style="color:grey">
        ChatReceiver.messages.add(message);</span>
    }
<span style="color:grey">
    public List&lt;String&gt; getMessages() {
        return ChatReceiver.messages;
    }

    public void setMessages(List&lt;String&gt; messages) {
        ChatReceiver.messages = messages;
    }
}</span>
</pre></li>
<li>create the <tt>net.java.dev.messageapi.chat.ChatMDB</tt>:<pre>
@MessageDriven(mappedName = "ChatTopic")
public class ChatMDB implements MessageListener {

	private final ChatApi receiver = new ChatReceiver();

	@Override
	public void onMessage(Message message) {
		String xml = getText(message);
		XmlStringDecoder.create(ChatApi.class, receiver).decode(xml);
	}

	private String getText(Message message) {
		try {
			return ((TextMessage) message).getText();
		} catch (JMSException e) {
			throw new RuntimeException("can't get text", e);
		}
	}
}
</pre>
<small style="color:green">we are working on a generic MDB, so you only have to configure the connection between a destination and your business bean</small></li>
<li style="color:grey">create the <tt>net.java.dev.messageapi.chat.ChatReceiveServlet</tt>:
<pre>
public class ChatReceiveServlet extends HttpServlet {
    private static final long serialVersionUID = 1L;

    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response)
            throws IOException {
        PrintWriter out = response.getWriter();
        out.println("&lt;html&gt;");
		out.println("  &lt;head&gt;");
		out.println("    &lt;meta http-equiv=\"refresh\" content=\"1\" &gt;");
		out.println("    &lt;title&gt;Chat Receive&lt;/title&gt;");
		out.println("  &lt;/head&gt;");
        out.println("  &lt;body&gt;");
        out.println("    &lt;h2&gt;Messages Received&lt;/h2&gt;");
        out.println("    &lt;ul&gt;");
        if (ChatReceiver.messages.isEmpty()) {
            out.append("      &lt;li&gt;&lt;i&gt;no messages received, yet&lt;/i&gt;&lt;/li&gt;\n");
        }
        for (String message : ChatReceiver.messages) {
            out.append("      &lt;li&gt;").append(message).append("&lt;/li&gt;\n");
        }
        out.println("    &lt;/ul&gt;");
        out.println("    &lt;small&gt;Please refresh manually&lt;/small&gt;");
        out.println("  &lt;/body&gt;");
        out.println("&lt;/html&gt;");
    }
}
</pre></li>
<li style="color:grey">build the war: <tt>mvn clean verify</tt></li>
</ol>

<h3>Deploy on your glassfish</h3>
<ol style="color:grey">
<li>open the <a href="http://localhost:4848">admin console</a></li>
<li>create the connection factory <tt>jms/ConnectionFactory</tt><ol>
    <li>go to <tt>Resources/JMS Resources/Connection Factories</tt></li>
    <li>click <tt>New...</tt></li>
    <li>set the <tt>Pool Name</tt> <tt>ConnectionFactory</tt></li>
    <li>set the <tt>Resource Type</tt> <tt>javax.jms.ConnectionFactory</tt></li>
    <li>hit return</li>
</ol></li>
<li>create the topic <tt>ChatTopic</tt><ol>
    <li>go to <tt>Resources/JMS Resources/Destination Resources</tt></li>
    <li>click <tt>New...</tt></li>
    <li>set the <tt>JNDI Name</tt> and the <tt>Physical Destination Name</tt> to <tt>Chat</tt></li>
    <li>hit return</li>
</ol></li>
<li>deploy the apps<ol>
    <li>go to <tt>Applications</tt></li>
    <li>click <tt>Deploy...</tt></li>
    <li>browse for your <tt>chat-send.war</tt></li>
    <li>hit <tt>continue</tt></li>
    <li>wait until the deploy is finished</li>
    <li>repeat for the <tt>chat-receive.war</tt></li>
</ol></li>
<li>open the <a href="http://localhost:8080/chat-send">sender</a></li>
<li>open the <a href="http://localhost:8080/chat-receive">receiver</a></li>
</ol>

